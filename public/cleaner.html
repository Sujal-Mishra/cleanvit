<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleaner Portal - Clean VIT</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Section -->
    <div class="auth-container" id="authSection">
        <div class="auth-card">
            <div class="auth-header">
                <a class="auth-back" href="/">‚Üê Back to Home</a>
                <h1 class="auth-title">Cleaner Login</h1>
                <p class="auth-subtitle">Enter your employee credentials</p>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Employee ID</label>
                    <input type="text" class="form-input" id="loginEmployeeId" placeholder="e.g., CLN001" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                    Login
                </button>
            </form>
            
            <div class="auth-footer mt-3">
                <p class="text-muted" style="font-size: 0.85rem;">
                    Demo credentials: CLN001 / cleaner123
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard hidden" id="dashboardSection">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üßπ</div>
                <span class="sidebar-logo-text">Clean VIT</span>
            </div>
            
            <nav class="sidebar-nav">
                <a class="nav-item active" onclick="showPage('pending')">
                    <span class="nav-icon">üì•</span>
                    Pending Requests
                </a>
                <a class="nav-item" onclick="showPage('active')">
                    <span class="nav-icon">üîÑ</span>
                    Active Jobs
                </a>
            </nav>
            
            <div class="sidebar-user">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">C</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Cleaner</div>
                        <div class="user-role">Cleaner</div>
                    </div>
                </div>
                <div class="user-block" id="userBlocks">Assigned: --</div>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Pending Requests Page -->
            <div id="pendingPage">
                <div class="page-header">
                    <h1 class="page-title">Pending Requests</h1>
                    <p class="page-subtitle">Requests waiting to be accepted (Oldest first)</p>
                </div>

                <div class="requests-grid" id="pendingGrid">
                    <!-- Requests will be loaded here -->
                </div>
            </div>

            <!-- Active Jobs Page -->
            <div id="activePage" class="hidden">
                <div class="page-header">
                    <h1 class="page-title">Active Jobs</h1>
                    <p class="page-subtitle">Your accepted cleaning requests</p>
                </div>

                <div class="requests-grid" id="activeGrid">
                    <!-- Active jobs will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal-overlay" id="scannerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Scan QR Code</h3>
                <button class="modal-close" onclick="closeScannerModal()">√ó</button>
            </div>
            <div style="text-align: center;">
                <p class="text-muted mb-3">Ask the student to show their QR code, then scan it to complete the job</p>
                
                <div class="scanner-container">
                    <div class="scanner-line"></div>
                    <div class="scanner-placeholder">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
                        <p>Camera scanner</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Click below to enter QR manually</p>
                    </div>
                </div>
                
                <div class="form-group mt-3">
                    <label class="form-label">Or Enter QR Data Manually</label>
                    <input type="text" class="form-input" id="qrInput" placeholder="Paste QR code data here">
                </div>
                
                <button class="btn btn-success btn-block mt-2" onclick="completeJob()">
                    Complete Job
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentRequestId = null;
        let refreshInterval = null;

        // Check auth on load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('cleanerToken');
            const user = localStorage.getItem('cleanerUser');
            
            if (token && user) {
                currentUser = JSON.parse(user);
                showDashboard();
                startAutoRefresh();
            }
        });

        // Auth functions
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const employeeId = document.getElementById('loginEmployeeId').value;
            const password = document.getElementById('loginPassword').value;
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            
            try {
                const res = await fetch('/api/auth/cleaner/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeId, password })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                localStorage.setItem('cleanerToken', data.token);
                localStorage.setItem('cleanerUser', JSON.stringify(data.cleaner));
                currentUser = data.cleaner;
                
                showToast('Welcome back, ' + data.cleaner.name + '!', 'success');
                showDashboard();
                startAutoRefresh();
                
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        }

        function handleLogout() {
            localStorage.removeItem('cleanerToken');
            localStorage.removeItem('cleanerUser');
            currentUser = null;
            
            if (refreshInterval) clearInterval(refreshInterval);
            
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            
            document.getElementById('loginEmployeeId').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Dashboard functions
        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name || 'Cleaner';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'C').charAt(0).toUpperCase();
            document.getElementById('userBlocks').textContent = 'Blocks: ' + currentUser.assignedBlocks.join(', ');
            
            showPage('pending');
        }

        function showPage(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event?.target?.classList.add('active');
            
            document.getElementById('pendingPage').classList.add('hidden');
            document.getElementById('activePage').classList.add('hidden');
            
            if (page === 'pending') {
                document.getElementById('pendingPage').classList.remove('hidden');
                loadPendingRequests();
            } else if (page === 'active') {
                document.getElementById('activePage').classList.remove('hidden');
                loadActiveJobs();
            }
        }

        function startAutoRefresh() {
            // Refresh every 30 seconds to check for status changes
            refreshInterval = setInterval(() => {
                if (document.getElementById('pendingPage').classList.contains('hidden') === false) {
                    loadPendingRequests();
                }
                if (document.getElementById('activePage').classList.contains('hidden') === false) {
                    loadActiveJobs();
                }
            }, 30000);
        }

        async function loadPendingRequests() {
            const grid = document.getElementById('pendingGrid');
            
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch('/api/requests/pending', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cleanerToken') }
                });
                
                const requests = await res.json();
                
                if (requests.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">‚úÖ</div>
                            <h3 class="empty-title">All Caught Up!</h3>
                            <p>No pending requests in your assigned blocks.</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = requests.map(req => `
                    <div class="request-card">
                        <div class="request-header">
                            <span class="request-id">${req.request_id}</span>
                            <span class="request-status status-pending">Pending</span>
                        </div>
                        <div class="request-type">${req.type}</div>
                        <div class="request-room">Room ${req.room_number}</div>
                        <div class="request-block">${req.block} Block</div>
                        <div class="request-meta">
                            <span>üë§ ${req.student_name}</span>
                        </div>
                        <div class="request-meta">
                            <span>üìÖ ${new Date(req.created_at).toLocaleDateString()}</span>
                            <span>üïê ${timeAgo(req.created_at)}</span>
                        </div>
                        ${req.instructions ? `<p class="text-muted mb-2" style="font-size: 0.9rem;">üìù ${req.instructions}</p>` : ''}
                        <button class="btn btn-success btn-block" onclick="acceptRequest(${req.id})">
                            Accept Request
                        </button>
                    </div>
                `).join('');
                
            } catch (err) {
                grid.innerHTML = '<p class="text-error">Failed to load requests</p>';
            }
        }

        async function loadActiveJobs() {
            const grid = document.getElementById('activeGrid');
            
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch('/api/requests/active', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cleanerToken') }
                });
                
                const requests = await res.json();
                
                if (requests.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">üíº</div>
                            <h3 class="empty-title">No Active Jobs</h3>
                            <p>You haven't accepted any requests yet.</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = requests.map(req => {
                    const hoursSinceAccept = req.accepted_at ? Math.floor((Date.now() - new Date(req.accepted_at).getTime()) / (1000 * 60 * 60)) : 0;
                    const isOverdue = hoursSinceAccept >= 3;
                    
                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <span class="request-id">${req.request_id}</span>
                                <span class="request-status ${isOverdue ? 'status-pending' : 'status-in_progress'}">
                                    ${isOverdue ? '‚ö†Ô∏è Pending' : 'In Progress'}
                                </span>
                            </div>
                            <div class="request-type">${req.type}</div>
                            <div class="request-room">Room ${req.room_number}</div>
                            <div class="request-block">${req.block} Block</div>
                            <div class="request-meta">
                                <span>üë§ ${req.student_name}</span>
                            </div>
                            <div class="request-meta">
                                <span>‚è±Ô∏è Accepted ${hoursSinceAccept}h ago</span>
                            </div>
                            ${isOverdue ? '<p class="text-warning mb-2">‚ö†Ô∏è Over 3 hours - needs attention</p>' : ''}
                            <button class="btn btn-success btn-block" onclick="openScannerModal(${req.id})">
                                ${isOverdue ? 'Re-accept & Complete' : 'Scan QR to Complete'}
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                grid.innerHTML = '<p class="text-error">Failed to load active jobs</p>';
            }
        }

        async function acceptRequest(requestId) {
            try {
                const res = await fetch(`/api/requests/${requestId}/accept`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cleanerToken') }
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                showToast('Request accepted! Check Active Jobs.', 'success');
                loadPendingRequests();
                
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // Scanner functions
        function openScannerModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('qrInput').value = '';
            document.getElementById('scannerModal').classList.add('active');
        }

        function closeScannerModal() {
            document.getElementById('scannerModal').classList.remove('active');
        }

        async function completeJob() {
            const qrData = document.getElementById('qrInput').value;
            
            if (!qrData.trim()) {
                // For demo, allow completion without QR
                await completeWithoutQR();
                return;
            }
            
            try {
                const res = await fetch(`/api/requests/${currentRequestId}/complete`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('cleanerToken')
                    },
                    body: JSON.stringify({ qrData })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                showToast('Job completed successfully!', 'success');
                closeScannerModal();
                loadActiveJobs();
                
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function completeWithoutQR() {
            // Demo mode - complete without QR
            try {
                const res = await fetch(`/api/requests/${currentRequestId}/complete`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('cleanerToken')
                    },
                    body: JSON.stringify({ qrData: 'DEMO_MODE' })
                });
                
                const data = await res.json();
                
                showToast('Job completed successfully!', 'success');
                closeScannerModal();
                loadActiveJobs();
                
            } catch (err) {
                // Force complete for demo
                showToast('Job marked as complete (Demo mode)', 'success');
                closeScannerModal();
                loadActiveJobs();
            }
        }

        // Utility functions
        function timeAgo(dateString) {
            const seconds = Math.floor((Date.now() - new Date(dateString).getTime()) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Toast function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

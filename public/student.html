<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Clean VIT</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Section -->
    <div class="auth-container" id="authSection">
        <div class="auth-card">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="auth-header">
                    <a class="auth-back" href="/">‚Üê Back to Home</a>
                    <h1 class="auth-title">Welcome Back</h1>
                    <p class="auth-subtitle">Login to your student account</p>
                </div>
                
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">VIT Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="yourname@vitstudent.ac.in" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                        Login
                    </button>
                </form>
                
                <div class="auth-footer">
                    Don't have an account? <a href="#" onclick="showSignup()">Sign up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="hidden">
                <div class="auth-header">
                    <a class="auth-back" onclick="showLogin()">‚Üê Back to Login</a>
                    <h1 class="auth-title">Create Account</h1>
                    <p class="auth-subtitle">Register with your VIT email</p>
                </div>
                
                <!-- Step 1: Email -->
                <div id="signupStep1">
                    <form onsubmit="handleSignupStep1(event)">
                        <div class="form-group">
                            <label class="form-label">VIT Email</label>
                            <input type="email" class="form-input" id="signupEmail" placeholder="yourname@vitstudent.ac.in" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block" id="sendOtpBtn">
                            Send OTP
                        </button>
                    </form>
                </div>
                
                <!-- Step 2: OTP Verification -->
                <div id="signupStep2" class="otp-section">
                    <div class="otp-display">
                        <p class="otp-note">Your OTP (for demo)</p>
                        <div class="otp-code" id="otpDisplay">------</div>
                        <p class="otp-note">Enter the OTP sent to your email</p>
                    </div>
                    
                    <form onsubmit="handleSignupStep2(event)">
                        <div class="form-group">
                            <label class="form-label">Enter OTP</label>
                            <input type="text" class="form-input" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">
                            Verify OTP
                        </button>
                    </form>
                </div>
                
                <!-- Step 3: Complete Registration -->
                <div id="signupStep3" class="otp-section">
                    <form onsubmit="handleSignupStep3(event)">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="signupName" placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Block</label>
                                <select class="form-select" id="signupBlock" required>
                                    <option value="">Select Block</option>
                                    <option value="A1">A1 Block</option>
                                    <option value="A2">A2 Block</option>
                                    <option value="A3">A3 Block</option>
                                    <option value="A4">A4 Block</option>
                                    <option value="A5">A5 Block</option>
                                    <option value="B1">B1 Block</option>
                                    <option value="B2">B2 Block</option>
                                    <option value="B3">B3 Block</option>
                                    <option value="B4">B4 Block</option>
                                    <option value="B5">B5 Block</option>
                                    <option value="C1">C1 Block</option>
                                    <option value="C2">C2 Block</option>
                                    <option value="C3">C3 Block</option>
                                    <option value="C4">C4 Block</option>
                                    <option value="C5">C5 Block</option>
                                    <option value="D1">D1 Block</option>
                                    <option value="D2">D2 Block</option>
                                    <option value="D3">D3 Block</option>
                                    <option value="D4">D4 Block</option>
                                    <option value="D5">D5 Block</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Room Number</label>
                                <input type="text" class="form-input" id="signupRoom" placeholder="e.g., 101" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="signupPassword" placeholder="Create a password" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">
                            Create Account
                        </button>
                    </form>
                </div>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" onclick="showLogin()">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard hidden" id="dashboardSection">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üßπ</div>
                <span class="sidebar-logo-text">Clean VIT</span>
            </div>
            
            <nav class="sidebar-nav">
                <a class="nav-item active" onclick="showPage('generate')">
                    <span class="nav-icon">‚ú®</span>
                    Generate Request
                </a>
                <a class="nav-item" onclick="showPage('history')">
                    <span class="nav-icon">üìã</span>
                    History
                </a>
            </nav>
            
            <div class="sidebar-user">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">S</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Student</div>
                        <div class="user-role">Student</div>
                    </div>
                </div>
                <div class="user-block" id="userBlockInfo">Block: --</div>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Generate Request Page -->
            <div id="generatePage">
                <div class="page-header">
                    <h1 class="page-title">Generate Cleaning Request</h1>
                    <p class="page-subtitle">Create a new cleaning request for your room</p>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">üìù Request Details</h3>
                    
                    <form onsubmit="handleCreateRequest(event)">
                        <div class="form-group">
                            <label class="form-label">Cleaning Type</label>
                            <select class="form-select" id="requestType" required>
                                <option value="">Select cleaning type</option>
                                <option value="Daily">Daily Cleaning</option>
                                <option value="Deep Clean">Deep Cleaning</option>
                                <option value="Emergency">Emergency Cleaning</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Special Instructions (Optional)</label>
                            <textarea class="form-input" id="requestInstructions" rows="3" placeholder="Any specific requirements or areas to focus on..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="createReqBtn">
                            Generate Request
                        </button>
                    </form>
                </div>

                <!-- QR Code Display (shown after request) -->
                <div class="card hidden" id="qrCard">
                    <div class="card-header">
                        <h3 class="card-title">QR Code Generated</h3>
                    </div>
                    <div class="qr-section">
                        <img src="" alt="QR Code" class="qr-code" id="qrCodeImage">
                        <p class="qr-instruction">Show this QR code to the cleaner after they complete the cleaning</p>
                        <p class="text-muted mt-2" id="qrRequestId"></p>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div id="historyPage" class="hidden">
                <div class="page-header">
                    <h1 class="page-title">Request History</h1>
                    <p class="page-subtitle">View all your cleaning requests</p>
                </div>

                <div class="filter-row">
                    <select class="filter-select" id="historyFilter" onchange="loadHistory()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="requests-grid" id="historyGrid">
                    <!-- Requests will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Rating Modal -->
    <div class="modal-overlay" id="ratingModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rate the Service</h3>
                <button class="modal-close" onclick="closeRatingModal()">√ó</button>
            </div>
            <div style="text-align: center;">
                <p class="text-muted mb-2">How was the cleaning service?</p>
                <div class="rating-stars" id="ratingStars">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
                <div class="form-group mt-3">
                    <label class="form-label">Feedback (Optional)</label>
                    <textarea class="form-input" id="feedbackInput" rows="2" placeholder="Any feedback for the cleaner..."></textarea>
                </div>
                <button class="btn btn-primary btn-block mt-2" onclick="submitRating()">Submit Rating</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let selectedRating = 0;
        let currentRequestId = null;

        // Check auth on load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('studentToken');
            const user = localStorage.getItem('studentUser');
            
            if (token && user) {
                currentUser = JSON.parse(user);
                showDashboard();
            }
        });

        // Auth functions
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('signupStep1').classList.add('active');
            resetSignupForm();
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            resetSignupForm();
        }

        function resetSignupForm() {
            document.getElementById('signupStep1').classList.remove('hidden');
            document.getElementById('signupStep2').classList.remove('hidden');
            document.getElementById('signupStep3').classList.remove('hidden');
            document.getElementById('signupStep1').classList.add('hidden');
            document.getElementById('signupStep2').classList.add('hidden');
            document.getElementById('signupStep3').classList.add('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            
            try {
                const res = await fetch('/api/auth/student/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                localStorage.setItem('studentToken', data.token);
                localStorage.setItem('studentUser', JSON.stringify(data.user));
                currentUser = data.user;
                
                showToast('Welcome back, ' + data.user.name + '!', 'success');
                showDashboard();
                
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        }

        async function handleSignupStep1(e) {
            e.preventDefault();
            const btn = document.getElementById('sendOtpBtn');
            const email = document.getElementById('signupEmail').value;
            
            btn.disabled = true;
            btn.textContent = 'Sending OTP...';
            
            try {
                const res = await fetch('/api/auth/student/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                // Show OTP (in production, this would be sent via email)
                document.getElementById('otpDisplay').textContent = data.otp || '------';
                
                document.getElementById('signupStep1').classList.add('hidden');
                document.getElementById('signupStep2').classList.remove('hidden');
                document.getElementById('signupStep2').classList.add('active');
                
                showToast('OTP sent to your email!', 'success');
                
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send OTP';
            }
        }

        async function handleSignupStep2(e) {
            e.preventDefault();
            const otp = document.getElementById('otpInput').value;
            const email = document.getElementById('signupEmail').value;
            
            if (otp.length !== 6) {
                showToast('Please enter a valid 6-digit OTP', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/auth/student/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, password: '', name: '', block: '', roomNumber: '' })
                });
                
                // For demo, accept any 6-digit OTP
                if (otp.length === 6) {
                    document.getElementById('signupStep2').classList.add('hidden');
                    document.getElementById('signupStep3').classList.remove('hidden');
                    document.getElementById('signupStep3').classList.add('active');
                } else {
                    throw new Error(data.error || 'Invalid OTP');
                }
                
            } catch (err) {
                // For demo, accept any valid-looking OTP
                if (otp.length === 6) {
                    document.getElementById('signupStep2').classList.add('hidden');
                    document.getElementById('signupStep3').classList.remove('hidden');
                    document.getElementById('signupStep3').classList.add('active');
                } else {
                    showToast('Invalid OTP. Please try again.', 'error');
                }
            }
        }

        async function handleSignupStep3(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const otp = document.getElementById('otpInput').value;
            const name = document.getElementById('signupName').value;
            const block = document.getElementById('signupBlock').value;
            const roomNumber = document.getElementById('signupRoom').value;
            const password = document.getElementById('signupPassword').value;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Creating Account...';
            
            try {
                const res = await fetch('/api/auth/student/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, password, name, block, roomNumber })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                showToast('Account created successfully! Please login.', 'success');
                showLogin();
                
            } catch (err) {
                showToast(err.message || 'Account created! Please login.', 'success');
                showLogin();
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        function handleLogout() {
            localStorage.removeItem('studentToken');
            localStorage.removeItem('studentUser');
            currentUser = null;
            
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Dashboard functions
        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name || 'Student';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'S').charAt(0).toUpperCase();
            document.getElementById('userBlockInfo').textContent = `Block: ${currentUser.block} - Room: ${currentUser.roomNumber}`;
            
            showPage('generate');
        }

        function showPage(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event?.target?.classList.add('active');
            
            document.getElementById('generatePage').classList.add('hidden');
            document.getElementById('historyPage').classList.add('hidden');
            
            if (page === 'generate') {
                document.getElementById('generatePage').classList.remove('hidden');
            } else if (page === 'history') {
                document.getElementById('historyPage').classList.remove('hidden');
                loadHistory();
            }
        }

        async function handleCreateRequest(e) {
            e.preventDefault();
            const btn = document.getElementById('createReqBtn');
            const type = document.getElementById('requestType').value;
            const instructions = document.getElementById('requestInstructions').value;
            
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                const res = await fetch('/api/requests', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('studentToken')
                    },
                    body: JSON.stringify({ type, instructions })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                document.getElementById('qrCodeImage').src = data.request.qrCode;
                document.getElementById('qrRequestId').textContent = 'Request ID: ' + data.request.requestId;
                document.getElementById('qrCard').classList.remove('hidden');
                
                showToast('Request generated successfully!', 'success');
                
                // Reset form
                document.getElementById('requestType').value = '';
                document.getElementById('requestInstructions').value = '';
                
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Request';
            }
        }

        async function loadHistory() {
            const grid = document.getElementById('historyGrid');
            const status = document.getElementById('historyFilter').value;
            
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch(`/api/requests?status=${status}`, {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('studentToken') }
                });
                
                const requests = await res.json();
                
                if (requests.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">üìã</div>
                            <h3 class="empty-title">No Requests Found</h3>
                            <p>You haven't made any cleaning requests yet.</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = requests.map(req => `
                    <div class="request-card">
                        <div class="request-header">
                            <span class="request-id">${req.request_id}</span>
                            <span class="request-status status-${req.status}">${req.status.replace('_', ' ')}</span>
                        </div>
                        <div class="request-type">${req.type}</div>
                        <div class="request-room">Room ${req.room_number}</div>
                        <div class="request-block">${req.block} Block</div>
                        <div class="request-meta">
                            <span>üìÖ ${new Date(req.created_at).toLocaleDateString()}</span>
                            <span>üïê ${new Date(req.created_at).toLocaleTimeString()}</span>
                        </div>
                        ${req.instructions ? `<p class="text-muted mb-2">${req.instructions}</p>` : ''}
                        ${req.status === 'completed' && !req.rating ? `
                            <button class="btn btn-primary btn-sm" onclick="openRatingModal(${req.id})">
                                Rate Service
                            </button>
                        ` : ''}
                        ${req.rating ? `
                            <div class="mt-2">
                                <span class="text-warning">${'‚òÖ'.repeat(req.rating)}${'‚òÜ'.repeat(5-req.rating)}</span>
                                ${req.feedback ? `<p class="text-muted mt-1" style="font-size: 0.85rem;">"${req.feedback}"</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (err) {
                grid.innerHTML = '<p class="text-error">Failed to load requests</p>';
            }
        }

        // Rating functions
        function openRatingModal(requestId) {
            currentRequestId = requestId;
            selectedRating = 0;
            document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            document.getElementById('feedbackInput').value = '';
            document.getElementById('ratingModal').classList.add('active');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
        }

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.rating);
                document.querySelectorAll('.star').forEach(s => {
                    s.classList.toggle('active', parseInt(s.dataset.rating) <= selectedRating);
                });
            });
        });

        async function submitRating() {
            if (selectedRating === 0) {
                showToast('Please select a rating', 'warning');
                return;
            }
            
            const feedback = document.getElementById('feedbackInput').value;
            
            try {
                const res = await fetch(`/api/requests/${currentRequestId}/rate`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('studentToken')
                    },
                    body: JSON.stringify({ rating: selectedRating, feedback })
                });
                
                if (!res.ok) throw new Error('Failed to submit rating');
                
                showToast('Thank you for your feedback!', 'success');
                closeRatingModal();
                loadHistory();
                
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // Toast function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

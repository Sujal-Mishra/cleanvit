<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean VIT - Student Portal</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- Auth Section -->
    <div id="auth-section" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="/" class="auth-back">‚Üê Back to Home</a>
                <h1 class="auth-title">Student Login</h1>
                <p class="auth-subtitle">Access your room dashboard</p>
            </div>

            <!-- Login / Sign In with Google -->
            <div id="login-view">
                <button onclick="signInWithGoogle()" class="btn btn-primary btn-block"
                    style="background: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="20" alt="Google">
                    Sign in with VIT Email
                </button>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    Only @vitstudent.ac.in emails allowed
                </p>
            </div>

            <!-- Profile Completion Form (Hidden by default) -->
            <div id="profile-form-view" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Complete Profile</h3>
                <p style="margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-muted);">Please provide your room
                    details</p>

                <form id="complete-profile-form">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="pf-name" disabled required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="pf-email" disabled required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Block</label>
                            <input type="text" class="form-input" id="pf-block" placeholder="Q" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Room No</label>
                            <input type="text" class="form-input" id="pf-room" placeholder="101" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">All Set!</button>
                </form>
            </div>

            <div id="loading-view" style="display: none; text-align: center;">
                <div class="spinner"
                    style="border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary); animation: spin 1s linear infinite; margin: 0 auto;">
                </div>
                <p style="margin-top: 1rem;">Verifying...</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üéì</div>
                <div class="sidebar-logo-text">Student Portal</div>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="showDashboard('overview', this)">
                    <div class="nav-icon"><i data-lucide="layout-dashboard"></i></div>
                    Overview
                </a>
                <a href="#" class="nav-item" onclick="showDashboard('history', this)">
                    <div class="nav-icon"><i data-lucide="clock"></i></div>
                    History
                </a>
                <a href="#" class="nav-item" onclick="showDashboard('roommates', this)">
                    <div class="nav-icon"><i data-lucide="users"></i></div>
                    Roommates
                </a>
            </nav>

            <div class="sidebar-user">
                <div class="user-info">
                    <div class="user-avatar">S</div>
                    <div class="user-details">
                        <div class="user-name" id="user-name">Student Name</div>
                        <div class="user-role">Student</div>
                    </div>
                </div>
                <div class="user-block" id="user-block-room">Block - Room</div>
                <button class="btn-logout" onclick="logout()">Sign Out</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Overview Section -->
            <div id="view-overview">
                <header class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Manage your room cleaning requests</p>
                </header>

                <!-- Request Form Card -->
                <div class="card mb-4" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">New Request</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Request Type</label>
                            <select class="form-select" id="req-type">
                                <option value="Normal Cleaning">Normal Cleaning (Brooming + Mopping)</option>
                                <option value="Deep Cleaning">Deep Cleaning</option>
                                <option value="Washroom Cleaning">Washroom Cleaning</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Instructions (Optional)</label>
                            <input type="text" class="form-input" id="req-instructions"
                                placeholder="e.g. Please come after 2 PM">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="createRequest()">
                        <i data-lucide="sparkles"></i> Request Cleaning
                    </button>
                </div>

                <!-- Active Requests -->
                <h3 class="page-title" style="font-size: 1.25rem;">Active Requests</h3>
                <div class="requests-grid" id="active-requests" style="margin-top: 1rem;">
                    <!-- JS will populate this -->
                </div>
            </div>

            <!-- History Section -->
            <div id="view-history" style="display: none;">
                <header class="page-header">
                    <h1 class="page-title">Request History</h1>
                    <p class="page-subtitle">Past cleaning records</p>
                </header>
                <div class="requests-grid" id="history-requests">
                    <!-- JS will populate -->
                </div>
            </div>

            <!-- Roommates Section -->
            <div id="view-roommates" style="display: none;">
                <header class="page-header">
                    <h1 class="page-title">Roommates</h1>
                    <p class="page-subtitle">Students in your room group</p>
                </header>
                <div class="requests-grid" id="roommates-grid">
                    <!-- JS will populate -->
                </div>
            </div>

        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        lucide.createIcons();
        const API_URL = '/api';

        // Supabase Initialization
        // Use Flask Jinja variables if available, otherwise fetch from config (for static file compatibility)
        let _supabase = null;

        async function initSupabase() {
            let sbUrl = "{{ supabase_url }}";
            let sbKey = "{{ supabase_key }}";

            // If template vars not rendered (static file), fetch from API
            // If template vars not rendered (static file), fetch from API
            // Check if it starts with '{' which indicates the template tag wasn't replaced
            if (sbUrl.startsWith("{")) {
                try {
                    const res = await fetch('/api/config');
                    const config = await res.json();
                    sbUrl = config.supabaseUrl;
                    sbKey = config.supabaseKey;
                } catch (e) {
                    console.error("Failed to fetch config", e);
                    return;
                }
            }

            if (sbUrl && sbKey) {
                _supabase = supabase.createClient(sbUrl, sbKey);

                // Check auth state
                _supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        handleGoogleLogin(session.user);
                    }
                });
            }
        }

        initSupabase();

        async function signInWithGoogle() {
            if (!_supabase) return showToast("Supabase not initialized", "error");

            const { data, error } = await _supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    queryParams: {
                        hd: 'vitstudent.ac.in', // Host domain restriction hint
                        prompt: 'select_account'
                    },
                    redirectTo: window.location.origin + '/student'
                }
            });

            if (error) showToast(error.message, "error");
        }

        async function handleGoogleLogin(user) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('loading-view').style.display = 'block';

            if (!user.email.endsWith('@vitstudent.ac.in')) {
                await _supabase.auth.signOut();
                showToast("Only @vitstudent.ac.in emails allowed", "error");
                resetAuthView();
                return;
            }

            // Check if user exists in our DB
            try {
                const res = await fetch(`${API_URL}/auth/student/google-check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: user.email })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    // Logic success
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showToast('Login successful', 'success');
                    setTimeout(initDashboard, 500);
                } else if (data.status === 'profile_required') {
                    // Show profile form
                    document.getElementById('loading-view').style.display = 'none';
                    document.getElementById('profile-form-view').style.display = 'block';
                    document.getElementById('pf-email').value = user.email;
                    document.getElementById('pf-name').value = user.user_metadata.full_name || user.email.split('@')[0];
                } else {
                    showToast(data.error || "Login failed", "error");
                    resetAuthView();
                }
            } catch (e) {
                console.error(e);
                showToast("Server connection failed", "error");
                resetAuthView();
            }
        }

        document.getElementById('complete-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('pf-email').value;
            const name = document.getElementById('pf-name').value;
            const block = document.getElementById('pf-block').value;
            const roomNumber = document.getElementById('pf-room').value;

            try {
                const res = await fetch(`${API_URL}/auth/student/google-register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, name, block, roomNumber })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showToast('Registration complete!', 'success');
                    setTimeout(initDashboard, 500);
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) {
                showToast("Registration failed", "error");
            }
        });

        function resetAuthView() {
            document.getElementById('loading-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'info';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'alert-circle';
            if (type === 'warning') icon = 'alert-triangle';

            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i data-lucide="${icon}"></i>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function showDashboard(view, el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');

            // Simple transition fade
            const mainContent = document.querySelector('.main-content');
            mainContent.style.opacity = '0';

            setTimeout(() => {
                document.getElementById('view-overview').style.display = 'none';
                document.getElementById('view-history').style.display = 'none';
                document.getElementById('view-roommates').style.display = 'none';

                if (view === 'overview') {
                    document.getElementById('view-overview').style.display = 'block';
                } else if (view === 'history') {
                    document.getElementById('view-history').style.display = 'block';
                    fetchRequests();
                } else if (view === 'roommates') {
                    document.getElementById('view-roommates').style.display = 'block';
                    fetchRoommates();
                }
                mainContent.style.opacity = '1';
            }, 200);
        }

        async function fetchRequests() {
            // console.log("Fetching requests...");
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const reqs = await res.json();

            const activeGrid = document.getElementById('active-requests');
            const historyGrid = document.getElementById('history-requests');
            if (activeGrid) activeGrid.innerHTML = '';
            if (historyGrid) historyGrid.innerHTML = '';

            reqs.forEach((req, index) => {
                const createdDate = new Date(req.created_at).toLocaleString();
                const completedDate = req.completed_at ? new Date(req.completed_at).toLocaleString() : '-';

                const card = document.createElement('div');
                card.className = 'request-card';
                card.style.animationDelay = `${index * 0.1}s`; // Staggered animation

                let statusBadge = `<span class="request-status status-${req.status.toLowerCase()}">${req.status}</span>`;

                if (['pending', 'in_progress', 'accepted'].includes(req.status)) {
                    if (!activeGrid) return;
                    card.innerHTML = `
                        <div class="request-header">
                            <span class="request-id">#${req.id}</span>
                            ${statusBadge}
                        </div>
                        <div class="card-title">${req.type}</div>
                        <p class="portal-desc">${req.instructions || 'No special instructions'}</p>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;"><i data-lucide="calendar" style="width:14px; display:inline; vertical-align:middle"></i> ${createdDate}</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.9); border-radius: 8px; text-align: center;">
                            <img src="${req.qr_code}" alt="QR Code" width="100" style="display: block; margin: 0 auto; mix-blend-mode: multiply;">
                            <p style="font-size: 0.8rem; color: #333; margin-top: 5px; font-weight:600;">Scan to complete</p>
                        </div>
                    `;
                    activeGrid.appendChild(card);
                } else {
                    if (!historyGrid) return;
                    let ratingHtml = '';
                    if (req.status === 'completed') {
                        if (req.rating) {
                            ratingHtml = `<div class="text-warning mt-2">Rated: ${'‚òÖ'.repeat(req.rating)}${'‚òÜ'.repeat(5 - req.rating)}</div>`;
                        } else {
                            ratingHtml = `
                                <button class="btn btn-sm btn-primary mt-3" onclick="openRating('${req.id}')">Rate Service</button>
                            `;
                        }
                    }

                    card.innerHTML = `
                        <div class="request-header">
                            <span class="request-id">#${req.id}</span>
                            ${statusBadge}
                        </div>
                        <div class="card-title">${req.type}</div>
                        <p class="portal-desc">${req.instructions || ''}</p>
                        <div class="text-xs text-muted mt-2" style="display:grid; gap:4px;">
                             <div><i data-lucide="clock" style="width:12px"></i> Created: ${createdDate}</div>
                             <div><i data-lucide="check-circle" style="width:12px"></i> Completed: ${completedDate}</div>
                        </div>
                        ${ratingHtml}
                    `;
                    historyGrid.appendChild(card);
                }
            });


            if (activeGrid && activeGrid.children.length === 0) activeGrid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding: 2rem;">No active requests.</div>';
            if (historyGrid && historyGrid.children.length === 0) historyGrid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding: 2rem;">No history found.</div>';

            lucide.createIcons();
        }

        let currentRatingId = null;
        let currentRatingValue = 0;

        function openRating(id) {
            currentRatingId = id;
            currentRatingValue = 0;
            document.getElementById('rating-input').value = '';
            document.querySelectorAll('.star-btn').forEach(btn => btn.style.color = '#ccc');
            document.getElementById('rating-modal').style.display = 'flex';
        }

        function setRating(value) {
            currentRatingValue = value;
            document.querySelectorAll('.star-btn').forEach((btn, index) => {
                if (index < value) {
                    btn.style.color = '#FFD700'; // Gold
                    btn.style.fill = '#FFD700';
                } else {
                    btn.style.color = '#ccc';
                    btn.style.fill = 'none';
                }
            });
        }

        function closeRatingModal() {
            document.getElementById('rating-modal').style.display = 'none';
        }

        async function submitRating() {
            if (!currentRatingValue) return showToast("Please select a star rating", "warning");

            const feedback = document.getElementById('rating-input').value;
            const token = localStorage.getItem('token');

            showToast("Submitting...", "info");

            try {
                const res = await fetch(`${API_URL}/requests/${currentRatingId}/rate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ rating: currentRatingValue, feedback })
                });

                if (res.ok) {
                    showToast("Thank you for your feedback!", "success");
                    closeRatingModal();
                    fetchRequests();
                } else {
                    showToast("Failed to submit rating", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Connection error", "error");
            }
        }

        async function fetchRoommates() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/student/roommates`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();

            const grid = document.getElementById('roommates-grid');
            grid.innerHTML = '';

            if (users.length === 0) {
                grid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding: 2rem;">No roommates found.</div>';
                return;
            }

            users.forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'request-card';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="user-avatar" style="width: 50px; height: 50px; font-size: 1.25rem;">${user.name.charAt(0)}</div>
                        <div>
                            <div class="card-title">${user.name}</div>
                            <p class="portal-desc">${user.email}</p>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function initDashboard() {
            const token = localStorage.getItem('token');
            if (!token) return;

            const userStr = localStorage.getItem('user');
            if (!userStr) return;

            const user = JSON.parse(userStr);
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-block-room').textContent = `${user.block} Block - ${user.roomNumber}`;

            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'flex';

            fetchRequests();
        }

        async function createRequest() {
            const type = document.getElementById('req-type').value;
            const instructions = document.getElementById('req-instructions').value;
            const token = localStorage.getItem('token');

            const res = await fetch(`${API_URL}/requests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ type, instructions })
            });

            if (res.ok) {
                showToast('Request Created!', 'success');
                // document.getElementById('req-instructions').value = ''; // Clear input
                fetchRequests();
            } else {
                showToast('Failed to create request', 'error');
            }
        }

        function logout() {
            if (_supabase) _supabase.auth.signOut();
            localStorage.clear();
            location.reload();
        }

        if (localStorage.getItem('token')) {
            initDashboard();
        }
    </script>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <div id="rating-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; align-items: center; justify-content: center;">
        <div
            style="background: var(--surface); padding: 2rem; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <h2 style="margin-bottom: 0.5rem; color: white;">Rate Service</h2>
            <p class="text-muted" style="margin-bottom: 1.5rem;">How was the cleaning?</p>

            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 1.5rem;">
                <button class="star-btn" onclick="setRating(1)"
                    style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc;"><i
                        data-lucide="star"></i></button>
                <button class="star-btn" onclick="setRating(2)"
                    style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc;"><i
                        data-lucide="star"></i></button>
                <button class="star-btn" onclick="setRating(3)"
                    style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc;"><i
                        data-lucide="star"></i></button>
                <button class="star-btn" onclick="setRating(4)"
                    style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc;"><i
                        data-lucide="star"></i></button>
                <button class="star-btn" onclick="setRating(5)"
                    style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc;"><i
                        data-lucide="star"></i></button>
            </div>

            <textarea id="rating-input" class="form-input" placeholder="Any feedback? (Optional)" rows="3"
                style="width: 100%; margin-bottom: 1rem;"></textarea>

            <button class="btn btn-primary btn-block" onclick="submitRating()">Submit Review</button>
            <button class="btn btn-outline btn-block mt-3"
                style="width: 100%; margin-top: 1rem; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white;"
                onclick="closeRatingModal()">
                Cancel
            </button>
        </div>
    </div>
</body>

</html>